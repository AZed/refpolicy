
policy_module(fstools,1.0)

########################################
#
# Declarations
#

type fsadm_t; #, mlsfileread;
type fsadm_exec_t;
init_system_domain(fsadm_t,fsadm_exec_t)
role system_r types fsadm_t;

type fsadm_tmp_t;
files_tmp_file(fsadm_tmp_t)

type swapfile_t;
files_type(swapfile_t)

########################################
#
# local policy
#

# ipc_lock is for losetup
allow fsadm_t self:capability { ipc_lock sys_rawio sys_admin sys_tty_config dac_override dac_read_search };
allow fsadm_t self:process ~{ ptrace setcurrent setexec setfscreate setrlimit execmem execmem execheap };
allow fsadm_t self:fd use;
allow fsadm_t self:fifo_file rw_file_perms;
allow fsadm_t self:unix_dgram_socket create_socket_perms;
allow fsadm_t self:unix_stream_socket create_stream_socket_perms;
allow fsadm_t self:unix_dgram_socket sendto;
allow fsadm_t self:unix_stream_socket connectto;
allow fsadm_t self:shm create_shm_perms;
allow fsadm_t self:sem create_sem_perms;
allow fsadm_t self:msgq create_msgq_perms;
allow fsadm_t self:msg { send receive };

can_exec(fsadm_t, fsadm_exec_t)

allow fsadm_t fsadm_tmp_t:dir create_dir_perms;
allow fsadm_t fsadm_tmp_t:file create_file_perms;
files_create_tmp_files(fsadm_t, fsadm_tmp_t, { file dir })

# Enable swapping to files
allow fsadm_t swapfile_t:file { getattr swapon };

kernel_read_system_state(fsadm_t)
kernel_read_kernel_sysctl(fsadm_t)
# Allow console log change (updfstab)
kernel_change_ring_buffer_level(fsadm_t)
# mkreiserfs needs this
kernel_getattr_proc(fsadm_t)
# Access to /initrd devices
kernel_rw_unlabeled_dir(fsadm_t)
kernel_use_unlabeled_blk_dev(fsadm_t)

dev_getattr_all_chr_files(fsadm_t)
# mkreiserfs and other programs need this for UUID
dev_read_rand(fsadm_t)
dev_read_urand(fsadm_t)
# Recreate /dev/cdrom.
dev_manage_generic_symlinks(fsadm_t)
# Access to /initrd devices
dev_search_usbfs(fsadm_t)
# for swapon
dev_read_sysfs(fsadm_t)
# Access to /initrd devices
dev_getattr_usbfs_dir(fsadm_t)

fs_search_auto_mountpoints(fsadm_t)
fs_getattr_xattr_fs(fsadm_t)
# remount file system to apply changes
fs_remount_xattr_fs(fsadm_t)
# for /dev/shm
fs_search_tmpfs(fsadm_t)
fs_getattr_tmpfs_dir(fsadm_t)

storage_raw_read_fixed_disk(fsadm_t)
storage_raw_write_fixed_disk(fsadm_t)
storage_raw_read_removable_device(fsadm_t)
storage_raw_write_removable_device(fsadm_t)
storage_read_scsi_generic(fsadm_t)
storage_swapon_fixed_disk(fsadm_t)

term_use_console(fsadm_t)

corecmd_list_bin(fsadm_t)
corecmd_list_sbin(fsadm_t)
corecmd_read_bin_symlink(fsadm_t)
corecmd_read_sbin_symlink(fsadm_t)
# cjp: these are probably not needed:
corecmd_read_bin_file(fsadm_t)
corecmd_read_bin_pipe(fsadm_t)
corecmd_read_bin_socket(fsadm_t)
corecmd_read_sbin_file(fsadm_t)
corecmd_read_sbin_pipe(fsadm_t)
corecmd_read_sbin_socket(fsadm_t)

domain_use_wide_inherit_fd(fsadm_t)

files_list_home(fsadm_t)
files_read_usr_files(fsadm_t)
files_read_etc_files(fsadm_t)
files_manage_lost_found(fsadm_t)
files_manage_isid_type_dir(fsadm_t)
# Write to /etc/mtab.
files_manage_etc_runtime_files(fsadm_t)
# Access to /initrd devices
files_rw_isid_type_dir(fsadm_t)
files_rw_isid_type_blk_node(fsadm_t)
# Recreate /mnt/cdrom.
files_manage_mnt_dirs(fsadm_t)

init_use_fd(fsadm_t)
init_use_script_pty(fsadm_t)

libs_use_ld_so(fsadm_t)
libs_use_shared_libs(fsadm_t)

logging_send_syslog_msg(fsadm_t)

miscfiles_read_localization(fsadm_t)

modutils_read_module_conf(fsadm_t)

seutil_read_config(fsadm_t)

userdom_use_unpriv_users_fd(fsadm_t)

tunable_policy(`read_default_t',`
	files_list_default(fsadm_t)
	files_read_default_files(fsadm_t)
	files_read_default_symlinks(fsadm_t)
	files_read_default_sockets(fsadm_t)
	files_read_default_pipes(fsadm_t)
')

optional_policy(`cron.te',`
	# for smartctl cron jobs
	cron_system_entry(fsadm_t,fsadm_exec_t)
')

optional_policy(`nis.te',`
	nis_use_ypbind(fsadm_t)
')

ifdef(`TODO',`
allow fsadm_t tmpfs_t:file { read write };
allow fsadm_t ramfs_t:fifo_file rw_file_perms;
ifdef(`gnome-pty-helper.te', `allow fsadm_t sysadm_gph_t:fd use;')
') dnl end TODO
